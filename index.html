<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mi Perfil - Facebook 2025</title>
  <style>
    :root {
      --fb-blue: #1877f2;
      --fb-dark: #1c1e21;
      --fb-gray: #f0f2f5;
      --text: #1c1e21;
      --light-text: #65676b;
      --font-family-profile: 'Segoe UI', Arial, sans-serif;
      --font-size-profile: 32px;
      --font-family-followers: 'Segoe UI', Arial, sans-serif;
      --font-size-followers: 15px;
      --font-family-info: 'Segoe UI', Arial, sans-serif;
      --font-size-info: 14px;
      --font-family-post-text: 'Segoe UI', Arial, sans-serif;
      --font-size-post-text: 16px;
      --font-family-post-time: 'Segoe UI', Arial, sans-serif;
      --font-size-post-time: 13px;
      --font-family-comment: 'Segoe UI', Arial, sans-serif;
      --font-size-comment: 13px;
      --font-family-friend: 'Segoe UI', Arial, sans-serif;
      --font-size-friend: 13px;
    }
    * { margin:0; padding:0; box-sizing:border-box; font-family: 'Segoe UI', Arial, sans-serif; }
    body { background: #e4e6eb; color: var(--text); line-height: 1.34; }

    .container { max-width: 980px; margin: 0 auto; padding: 20px 10px; }

    /* Header */
    .header {
      background: white;
      padding: 12px 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,.1);
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo { font-size: 28px; font-weight: 900; color: var(--fb-blue); }
    .header-right {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .header-left {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .header-right button, .header-right label, .header-left button, .header-left label {
      background: var(--fb-blue);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      white-space: nowrap;
    }
    .header-right .reset-btn {
      background: #e74c3c;
    }
    .version-info {
      color: #65676b;
      font-size: 14px;
      font-weight: 400;
      white-space: nowrap;
    }

    /* Modo Editor */
    .edit-mode-only { display: none; }
    body.editor-active .edit-mode-only { display: block !important; }
    body.editor-active .view-mode-only { display: none !important; }

    /* Cover + Profile */
    .cover-container { position: relative; margin-top: 20px; background: white; border-radius: 8px; overflow: hidden; }
    #cover-photo {
      width: 100%;
      height: 350px;
      object-fit: cover;
      background: #ccc;
      cursor: pointer;
      display: block;
    }
    .profile-section {
      display: flex;
      align-items: flex-end;
      padding: 0 20px;
      position: relative;
      background: white;
      padding-bottom: 16px;
    }
    #profile-pic {
      width: 168px;
      height: 168px;
      border-radius: 50%;
      border: 5px solid white;
      object-fit: cover;
      background: #fff;
      cursor: pointer;
      margin-top: -84px;
    }
    .profile-info {
      margin-left: 20px;
      flex: 1;
    }
    #profile-name {
      font-size: var(--font-size-profile);
      font-family: var(--font-family-profile);
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }
    .badge {
      width: 24px;
      height: 24px;
      border-radius: 50%;
    }
    .comment-badge {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-left: 4px;
      vertical-align: middle;
    }
    #followers-count {
      font-size: var(--font-size-followers);
      font-family: var(--font-family-followers);
      color: #65676b;
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: text;
    }
    #followers-count:hover {
      background: #f0f2f5;
    }
    .invisible-lift-btn {
      opacity: 0;
      pointer-events: none;
      width: 0;
      height: 0;
      padding: 0;
      margin: 0;
      border: none;
      background: none;
    }

    .card {
      background: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 2px rgba(0,0,0,.1);
      margin-bottom: 20px;
    }

    /* Reacciones */
    .reactions-bar {
      padding: 8px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: #65676b;
      border-top: 1px solid #e4e6eb;
    }
    .reaction-summary {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .reaction-icons {
      display: flex;
      align-items: center;
      gap: 2px;
      font-size: 16px;
    }
    .reaction-count {
      margin-left: 6px;
      color: #65676b;
      cursor: pointer;
    }
    .comments-shares {
      color: #65676b;
      cursor: pointer;
    }

    .post {
      background: white;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 1px 2px rgba(0,0,0,.1);
      overflow: hidden;
    }
    .post-header {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      position: relative;
    }
    .post-header img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 12px;
    }
    .post-author {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .post-time { 
      font-size: var(--font-size-post-time); 
      font-family: var(--font-family-post-time);
      color: #65676b; 
    }

    .post-content { 
      padding: 0 16px 12px; 
      white-space: pre-wrap;
      font-size: var(--font-size-post-text);
      font-family: var(--font-family-post-text);
    }
    .post-content a { color: var(--fb-blue); font-weight: 600; }
    .post-image { width: 100%; max-height: 600px; object-fit: cover; cursor: pointer; }

    /* Fotos Grid */
    .photos-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 10px;
    }
    .photo-item {
      position: relative;
      width: 100%;
      padding-bottom: 100%;
      overflow: hidden;
      border-radius: 8px;
      background: #f0f2f5;
    }
    .photo-item img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      cursor: pointer;
    }
    .photo-item button {
      position: absolute;
      right: 4px;
      top: 4px;
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      z-index: 10;
      font-size: 18px;
      line-height: 24px;
    }

    .friends-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 10px;
    }
    .friend-item {
      position: relative;
    }
    .friend-item img {
      width: 100%;
      height: 110px;
      object-fit: cover;
      border-radius: 8px;
    }
    .friend-name {
      margin-top: 4px;
      font-weight: 600;
      font-size: var(--font-size-friend);
      font-family: var(--font-family-friend);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .friend-badge {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
      display: inline-block;
      vertical-align: middle;
    }
    .friend-item button {
      position: absolute;
      right: 4px;
      top: 4px;
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      z-index: 10;
      font-size: 18px;
      line-height: 24px;
    }
    .friend-item .edit-btn {
      right: 32px;
      background: rgba(0,0,0,0.7);
    }

    /* Modal */
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000;
    }
    .modal-content {
      background: white; padding: 24px; border-radius: 12px; width: 500px; max-width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 1001;
    }
    .modal-content h3 {
      margin-bottom: 16px;
    }
    .modal-content p {
      margin-bottom: 12px;
    }
    .modal-content input[type="text"], .modal-content input[type="url"], .modal-content input[type="number"], .modal-content select, .modal-content textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    .modal-content button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin-left: 8px;
    }

    /* Comentarios */
    .comments-section {
      border-top: 1px solid #e4e6eb;
      padding: 12px 16px;
      display: none;
    }
    .comments-section.visible {
      display: block;
    }
    .comment-item {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      position: relative;
    }
    .comment-item img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
    }
    .comment-bubble {
      background: #f0f2f5;
      padding: 8px 12px;
      border-radius: 18px;
      flex: 1;
      position: relative;
    }
    .comment-author {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .comment-text {
      font-size: var(--font-size-comment);
      font-family: var(--font-family-comment);
    }
    .comment-heart {
      position: absolute;
      bottom: -8px;
      right: 8px;
      background: white;
      border-radius: 50%;
      padding: 2px 4px;
      font-size: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      cursor: pointer;
    }
    .comment-heart:hover {
      transform: scale(1.1);
    }
    .comment-reply {
      margin-left: 40px;
      margin-top: 8px;
    }

    .character-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #f0f2f5;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
    }
    .character-item:hover {
      background: #e4e6eb;
    }
    .character-item img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    .character-item.profile-character, .character-item.friend-character {
      border: 2px solid var(--fb-blue);
      cursor: default;
    }
    .character-item.profile-character:hover, .character-item.friend-character:hover {
      background: #f0f2f5;
    }
    
    .editable-info {
        font-size: var(--font-size-info); 
        font-family: var(--font-family-info); 
        white-space: pre-line; 
        line-height:1.6; 
        margin-top:8px;
    }

    .info-divider {
      border: none;
      border-top: 1px solid #e4e6eb;
      margin: 12px 0;
    }

    .style-control-group {
      border: 1px solid #ddd;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      background: #f9f9f9;
    }

    .reaction-emojis-input {
      width: 60px;
      padding: 4px 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      text-align: center;
      display: inline-block;
    }

    .comment-tree-item {
      margin-bottom: 12px;
      padding: 8px;
      background: #f9f9f9;
      border-radius: 8px;
      border-left: 3px solid #ddd;
    }

    .comment-tree-item.reply {
      margin-left: 20px;
      border-left-color: var(--fb-blue);
    }

    .comment-controls {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    /* Image Crop Canvas */
    .crop-container {
      position: relative;
      width: 100%;
      max-width: 500px;
      margin: 20px auto;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
    }
    .crop-canvas-wrapper {
      position: relative;
      width: 100%;
      height: 400px;
      overflow: hidden;
      cursor: move;
      background: #000;
    }
    .crop-canvas {
      position: absolute;
      max-width: none;
    }
    .crop-controls {
      background: #f0f2f5;
      padding: 12px;
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }
    .crop-controls button {
      background: var(--fb-blue);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    .crop-controls input[type="range"] {
      width: 150px;
    }

    @media print {
      .header, .edit-mode-only, .no-print { display: none !important; }
      body { background: white; }
      .container { padding: 0; max-width: 100%; }
    }
    @media (max-width: 900px) {
      .main-grid { grid-template-columns: 1fr !important; }
      .profile-section { flex-direction: column; align-items: center; text-align: center; }
      #profile-pic { width: 120px; height: 120px; margin-top: -60px; }
      .profile-info { margin-left: 0; margin-top: 12px; }
      .header { flex-direction: column; gap: 8px; }
      .header-left, .header-right { width: 100%; justify-content: center; }
      .version-info { text-align: center; width: 100%; }
    }
  </style>
</head>
<body>

<div class="header">
  <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap; width: 100%;">
    <div class="logo">Fakebook</div>
    <div class="header-left">
      <button class="view-mode-only" onclick="window.print()">Imprimir Perfil</button>
      <button class="view-mode-only" onclick="toggleEditMode()">Editar Perfil</button>
      <button class="edit-mode-only" onclick="toggleEditMode()">Salir del Editor</button>
    </div>
    <div class="header-right" style="margin-left: auto;">
      <span class="version-info view-mode-only">Fakebook-Fabijose21-v3.0</span>
      <button class="edit-mode-only" onclick="openStyleModal()">Personalizar Estilo</button>
      <button class="edit-mode-only reset-btn" onclick="resetProfile()">Resetear Perfil</button>
      <button class="edit-mode-only" onclick="exportProfile()">Exportar</button>
      <label class="edit-mode-only" style="cursor:pointer;">
        Importar <input type="file" id="import-file" style="display:none" accept=".json" onchange="importProfile(event)">
      </label>
    </div>
  </div>
</div>

<div class="container">
  <div class="cover-container">
    <img id="cover-photo" src="" alt="Cover" style="background:#ccc;" onclick="isEditor && openImageUploadModal('cover')" />
    <button class="edit-mode-only" style="position:absolute; bottom:16px; right:16px; background:rgba(0,0,0,0.6); color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;" onclick="openImageUploadModal('cover')">Cambiar Portada</button>
    <div class="profile-section">
      <img id="profile-pic" src="" alt="Perfil" style="background:#e4e6eb;" onclick="isEditor && openImageUploadModal('profilePic')" />
      <button class="edit-mode-only" style="position:absolute; top:-40px; left:120px; background:rgba(0,0,0,0.6); color:white; border:none; padding:8px; border-radius:50%; width:40px; height:40px; cursor:pointer; line-height:24px;" onclick="openImageUploadModal('profilePic')">üì∑</button>
      <div class="profile-info">
        <h1 id="profile-name" contenteditable="false">
          <button class="invisible-lift-btn">.</button>
        </h1>
        <div id="followers-count" contenteditable="false"></div>
        <div class="edit-mode-only" style="margin-top:8px;">
          <button onclick="toggleBadge()">Alternar Verificado</button>
        </div>
      </div>
    </div>
  </div>

  <div class="main-grid" style="display:grid;grid-template-columns:360px 1fr;gap:20px;margin-top:20px;">
    <div>
      <div class="card">
        <h3>Informaci√≥n</h3>
        <div id="info-display" class="view-mode-only editable-info"></div>
        <textarea id="info-text" class="edit-mode-only" placeholder="Biograf√≠a o presentaci√≥n..." style="width:100%; min-height:80px; border:1px solid #ddd; border-radius:8px; padding:12px; margin-top:8px; font-size:14px;"></textarea>
        
        <hr class="info-divider view-mode-only" id="info-divider-view">
        <hr class="info-divider edit-mode-only" style="margin-top:8px;">
        
        <div id="info-details-display" class="view-mode-only editable-info"></div>
        <textarea id="info-details-text" class="edit-mode-only" placeholder="Informaci√≥n adicional (estudios, trabajo, ciudad, etc.)..." style="width:100%; min-height:80px; border:1px solid #ddd; border-radius:8px; padding:12px; margin-top:8px; font-size:14px;"></textarea>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Fotos</h3>
          <button class="edit-mode-only" onclick="openAddPhotoModal()">+ A√±adir fotos</button>
        </div>
        <div class="photos-grid" id="photos-container"></div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Amigos</h3>
          <button class="edit-mode-only" onclick="openAddFriendModal(-1)">+ A√±adir amigo</button>
        </div>
        <div class="friends-grid" id="friends-container"></div>
      </div>
    </div>

    <div>
      <div class="create-post edit-mode-only card">
        <textarea id="new-post-text" placeholder="¬øEn qu√© est√°s pensando?" rows="4" style="width:100%; border:1px solid #ddd; border-radius:8px; padding:12px; font-size:14px;"></textarea>
        <div style="margin-top:10px;display:flex;gap:10px;">
          <button onclick="openPostImageModal('new')">A√±adir foto</button>
          <button onclick="createNewPost()">Publicar</button>
        </div>
      </div>

      <div id="posts-container"></div>
    </div>
  </div>
</div>

<!-- Modal Personalizar Estilo -->
<div class="modal" id="style-modal" style="display:none;">
  <div class="modal-content">
    <h3>Personalizar Estilo</h3>
    <p>Puedes usar fuentes comunes (Arial, 'Times New Roman', Courier New, etc.) o fuentes instaladas en tu sistema.</p>
    
    <div id="style-controls"></div>
    
    <div style="margin-top:20px; text-align:right; border-top: 1px solid #ddd; padding-top: 16px;">
      <button onclick="resetAllStyles()" style="background:#e74c3c; color:white;">Restablecer Todos</button>
      <button onclick="closeStyleModal()">Cerrar</button>
      <button style="background:var(--fb-blue);color:white;" onclick="applyStyles()">Aplicar Estilos</button>
    </div>
  </div>
</div>

<!-- Modal Imagen Upload con Recorte -->
<div class="modal" id="image-upload-modal" style="display:none; z-index: 2000;">
  <div class="modal-content" style="z-index: 2001; max-width: 600px;">
    <h3 id="image-upload-title">Cambiar Imagen</h3>
    <div style="margin-bottom:12px;">
      <button onclick="switchImageInput('file')" id="btn-file-input">Subir Archivo</button>
      <button onclick="switchImageInput('url')" id="btn-url-input">Usar Link/URL</button>
    </div>
    
    <div id="file-input-section">
      <p>
        <button onclick="document.getElementById('generic-file-input').click()">Seleccionar Archivo</button>
        <input type="file" id="generic-file-input" style="display:none;" accept="image/*" onchange="previewFile(event)">
        <span id="file-name-preview">Sin archivo seleccionado</span>
      </p>
    </div>
    
    <div id="url-input-section" style="display:none;">
      <p>Link/URL: <input type="url" id="generic-url-input" placeholder="https://..." oninput="previewUrl(event)"></p>
    </div>
    
    <div id="crop-section" style="display:none;">
      <div class="crop-container">
        <div class="crop-canvas-wrapper" id="crop-canvas-wrapper">
          <img id="crop-canvas" class="crop-canvas" src="" alt="Imagen para recortar">
        </div>
        <div class="crop-controls">
          <label>Zoom: <input type="range" id="zoom-slider" min="50" max="200" value="100" oninput="updateZoom(this.value)"></label>
          <button onclick="resetCrop()">Reiniciar</button>
        </div>
      </div>
      <p style="text-align:center; color:#65676b; font-size:13px; margin-top:8px;">
        Arrastra la imagen para reposicionar. Usa el zoom para ajustar el tama√±o.
      </p>
    </div>
    
    <div style="text-align:center; margin-top:16px;" id="simple-preview-section">
        <img id="image-preview" src="" style="max-width:100%; max-height:200px; display:none; border:1px solid #ddd; border-radius:4px;">
    </div>

    <div style="margin-top:20px; text-align:right;">
      <button onclick="closeImageUploadModal()">Cancelar</button>
      <button id="enable-crop-btn" onclick="enableCropMode()" style="background:#27ae60; color:white; display:none;">Recortar/Mover</button>
      <button id="use-default-btn" onclick="saveImage()" style="background:#95a5a6; color:white; display:none;">Usar Predeterminado</button>
      <button id="save-image-btn" style="background:var(--fb-blue);color:white;" onclick="saveImage()">Guardar Imagen</button>
    </div>
  </div>
</div>

<!-- Modal A√±adir Fotos -->
<div class="modal" id="add-photo-modal" style="display:none;">
  <div class="modal-content">
    <h3>A√±adir Fotos a la Galer√≠a</h3>
    <div id="photo-add-options"></div>
    <div style="margin-top:20px; text-align:right;">
      <button onclick="closeAddPhotoModal()">Cancelar</button>
      <button style="background:var(--fb-blue);color:white;" onclick="savePhotos()">A√±adir</button>
    </div>
  </div>
</div>

<!-- Modal A√±adir/Editar Amigo -->
<div class="modal" id="add-friend-modal" style="display:none;">
  <div class="modal-content">
    <h3 id="friend-modal-title">A√±adir Amigo</h3>
    <p>Nombre: <input type="text" id="friend-name"></p>
    <p>Foto: <button onclick="openImageUploadModal('friend')">Cambiar Foto</button> <span id="friend-pic-name"></span></p>
    <p>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" id="friend-verified" style="width: auto;">
        <span>Verificado ‚òëÔ∏è</span>
      </label>
    </p>
    <div style="margin-top:20px; text-align:right;">
      <button onclick="closeAddFriendModal()">Cancelar</button>
      <button style="background:var(--fb-blue);color:white;" onclick="saveFriend()">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal Editar Reacciones -->
<div class="modal" id="reactions-modal" style="display:none;">
  <div class="modal-content">
    <h3>Editar Reacciones</h3>
    <p>Total de reacciones: <input type="text" id="reaction-total" style="width:100%; padding:8px;"></p>
    <p>Comentarios: <input type="text" id="reaction-comments" style="width:100%; padding:8px;"></p>
    <p>Compartidos: <input type="text" id="reaction-shares" style="width:100%; padding:8px;"></p>
    <div style="margin-top:20px; text-align:right;">
      <button onclick="closeReactionsModal()">Cancelar</button>
      <button style="background:var(--fb-blue);color:white;" onclick="saveReactions()">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal Comentarios -->
<div class="modal" id="comments-modal" style="display:none;">
  <div class="modal-content">
    <h3>Gestionar Comentarios</h3>
    
    <div style="display:flex; gap:8px; border-bottom:2px solid #e4e6eb; margin-bottom:16px;">
      <button id="tab-comments" onclick="switchTab('comments')" style="padding:8px 16px; border:none; background:none; border-bottom:3px solid var(--fb-blue); font-weight:600; cursor:pointer;">Comentarios</button>
      <button id="tab-characters" onclick="switchTab('characters')" style="padding:8px 16px; border:none; background:none; border-bottom:3px solid transparent; cursor:pointer;">Personajes</button>
    </div>

    <div id="comments-tab-content">
      <div id="comments-tree"></div>
      <div style="margin-top:16px; border-top:1px solid #ddd; padding-top:16px;">
        <p><strong>A√±adir comentario</strong></p>
        <p>
          <button onclick="openCharacterSelector()">Seleccionar personaje</button>
          <span id="selected-character-name" style="margin-left:8px; color:#65676b;"></span>
        </p>
        <p id="parent-comment-indicator" style="display:none; color:var(--fb-blue); font-size:12px; margin:8px 0;">
          Responder a: <span id="parent-comment-name"></span>
          <button onclick="cancelParentSelection()" style="background:#e74c3c; color:white; font-size:11px; padding:2px 8px; margin-left:8px;">Cancelar</button>
        </p>
        <p>Comentario: <input type="text" id="new-comment-text"></p>
        <button onclick="addCommentToPost()" style="background:var(--fb-blue); color:white;">A√±adir</button>
      </div>
    </div>

    <div id="characters-tab-content" style="display:none;">
      <div id="characters-list"></div>
      <div style="margin-top:16px; border-top:1px solid #ddd; padding-top:16px;">
        <p><strong>Crear nuevo personaje</strong></p>
        <p>Nombre: <input type="text" id="new-char-name"></p>
        <p>Foto: <button onclick="openImageUploadModal('character')">Seleccionar foto</button> <span id="new-char-pic-name"></span></p>
        <p>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="char-verified" style="width: auto;">
            <span>Verificado</span>
          </label>
        </p>
        <button onclick="saveCharacter()" style="background:var(--fb-blue); color:white;">Guardar personaje</button>
      </div>
    </div>

    <div style="margin-top:20px; text-align:right; border-top:1px solid #ddd; padding-top:16px;">
      <button onclick="closeCommentsModal()">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal Selector de Personajes -->
<div class="modal" id="character-selector-modal" style="display:none;">
  <div class="modal-content">
    <h3>Seleccionar Personaje</h3>
    <div id="character-selector-list"></div>
    <div style="margin-top:20px; text-align:right;">
      <button onclick="closeCharacterSelector()">Cancelar</button>
    </div>
  </div>
</div>

<script>
  let isEditor = false;
  let tempPostImage = null;
  let tempFriendPic = null;
  let tempCharPic = null;
  let tempPhotos = [];
  let currentPostForReactions = -1;
  let currentPostForComments = -1;
  let selectedCharacter = null;
  let currentTab = 'comments';
  let editingFriendIndex = -1;
  let selectedParentCommentPath = null;
  
  let currentImageTarget = null;
  let currentImageSourceType = 'file';
  let currentImagePreviewData = null;
  let currentImageCallback = null;
  
  // Crop variables
  let cropMode = false;
  let cropX = 0;
  let cropY = 0;
  let cropZoom = 100;
  let isDragging = false;
  let startDragX = 0;
  let startDragY = 0;
  let cropOriginalImage = null;
  
  const FONT_OPTIONS = ['Arial', 'Verdana', 'Tahoma', 'Trebuchet MS', 'Times New Roman', 'Georgia', 'Courier New', 'Monospace', 'Segoe UI'];

  const defaultBadges = [
    "https://cdn-icons-png.freepik.com/512/11820/11820285.png",
  ];

  const DEFAULT_STYLES = {
    fontFamilyProfile: 'Segoe UI, Arial, sans-serif',
    fontSizeProfile: '32px',
    fontFamilyFollowers: 'Segoe UI, Arial, sans-serif',
    fontSizeFollowers: '15px',
    fontFamilyInfo: 'Segoe UI, Arial, sans-serif',
    fontSizeInfo: '14px',
    fontFamilyPostText: 'Segoe UI, Arial, sans-serif',
    fontSizePostText: '16px',
    fontFamilyPostTime: 'Segoe UI, Arial, sans-serif',
    fontSizePostTime: '13px',
    fontFamilyComment: 'Segoe UI, Arial, sans-serif',
    fontSizeComment: '13px',
    fontFamilyFriend: 'Segoe UI, Arial, sans-serif',
    fontSizeFriend: '13px',
  };

  let profileData = {
    name: "",
    profilePic: "",
    cover: "",
    badge: "",
    followers: "",
    info: "",
    infoDetails: "",
    photos: [],
    friends: [],
    posts: [],
    characters: [],
    styles: {...DEFAULT_STYLES}
  };

  window.onload = () => {
    loadProfile();
    applyStylesToCSS();
    renderAll();
  };

  function toggleEditMode() {
    isEditor = !isEditor;
    document.body.classList.toggle('editor-active', isEditor);
    document.getElementById('profile-name').contentEditable = isEditor;
    document.getElementById('followers-count').contentEditable = isEditor;
    renderAll();
  }

  function resetProfile() {
    if (!confirm('¬øEst√°s seguro de que quieres resetear todo el perfil? Esta acci√≥n no se puede deshacer.')) {
      return;
    }
    if (!confirm('CONFIRMACI√ìN FINAL: ¬øEliminar TODOS los datos del perfil?')) {
      return;
    }
    
    profileData = {
      name: "",
      profilePic: "",
      cover: "",
      badge: "",
      followers: "",
      info: "",
      infoDetails: "",
      photos: [],
      friends: [],
      posts: [],
      characters: [],
      styles: {...DEFAULT_STYLES}
    };
    
    applyStylesToCSS();
    saveProfile();
    renderAll();
    alert('Perfil reseteado correctamente');
  }

  function toggleBadge() {
    profileData.badge = profileData.badge ? "" : defaultBadges[0];
    saveProfile();
    renderAll();
  }

  function renderAll() {
    const nameEl = document.getElementById('profile-name');
    nameEl.innerHTML = (profileData.name || '') + (profileData.badge ? `<img class="badge" src="${profileData.badge}" alt="‚úì">` : '');
    
    document.getElementById('profile-pic').src = profileData.profilePic || '';
    document.getElementById('cover-photo').src = profileData.cover || '';
    document.getElementById('followers-count').textContent = profileData.followers || '';

    const hasInfo = profileData.info && profileData.info.trim();
    const hasDetails = profileData.infoDetails && profileData.infoDetails.trim();
    
    document.getElementById('info-display').innerHTML = hasInfo ? profileData.info : '<span style="color:#65676b">A√±ade informaci√≥n sobre ti</span>';
    document.getElementById('info-text').value = profileData.info || "";
    
    document.getElementById('info-divider-view').style.display = (hasInfo || hasDetails) ? 'block' : 'none';
    
    document.getElementById('info-details-display').innerHTML = hasDetails ? profileData.infoDetails : '<span style="color:#65676b">Informaci√≥n adicional</span>';
    document.getElementById('info-details-text').value = profileData.infoDetails || "";
    
    nameEl.oninput = () => { 
      const text = nameEl.textContent.trim();
      profileData.name = text;
      saveProfile();
      renderPosts();
    };
    
    document.getElementById('followers-count').oninput = () => {
      profileData.followers = document.getElementById('followers-count').textContent.trim();
      saveProfile();
    };

    document.getElementById('info-text').oninput = () => { 
      profileData.info = document.getElementById('info-text').value; 
      saveProfile(); 
      renderAll(); 
    };

    document.getElementById('info-details-text').oninput = () => { 
      profileData.infoDetails = document.getElementById('info-details-text').value; 
      saveProfile(); 
      renderAll(); 
    };

    renderPhotos();
    renderFriends();
    renderPosts();
  }

  function renderPhotos() {
    const container = document.getElementById('photos-container');
    if (!profileData.photos || profileData.photos.length === 0) {
      container.innerHTML = '';
      return;
    }
    
    container.innerHTML = profileData.photos.map((photo, i) => `
      <div class="photo-item">
        <img src="${photo}" alt="Foto">
        ${isEditor ? `<button onclick="deletePhoto(${i})">√ó</button>` : ''}
      </div>
    `).join('');
  }

  function deletePhoto(index) {
    profileData.photos.splice(index, 1);
    saveProfile();
    renderPhotos();
  }

  function openAddPhotoModal() {
    document.getElementById('add-photo-modal').style.display = 'flex';
    tempPhotos = [];
    document.getElementById('photo-add-options').innerHTML = `
      <div style="margin-bottom:12px;">
        <button onclick="addPhotoInput('file')">Subir Archivo</button>
        <button onclick="addPhotoInput('url')">Usar Link/URL</button>
      </div>
      <div id="dynamic-photo-inputs"></div>
    `;
    addPhotoInput('file');
  }

  function addPhotoInput(type) {
    const container = document.getElementById('dynamic-photo-inputs');
    const index = container.children.length;
    
    if (type === 'file') {
      const inputId = `photo-file-${index}`;
      container.innerHTML += `
        <p style="border: 1px solid #ddd; padding:8px; border-radius:6px; margin-bottom:8px;">
          <button onclick="document.getElementById('${inputId}').click()">Seleccionar Foto (Archivo)</button>
          <input type="file" id="${inputId}" style="display:none;" accept="image/*" onchange="handlePhotoFile(event, ${index})">
          <span id="photo-name-${index}" style="margin-left:8px;">Sin archivo seleccionado</span>
          <button onclick="removePhotoInput(${index})" style="background:red; color:white; float:right;">√ó</button>
        </p>
      `;
    } else {
      const inputId = `photo-url-${index}`;
      container.innerHTML += `
        <p style="border: 1px solid #ddd; padding:8px; border-radius:6px; margin-bottom:8px;">
          Link/URL: <input type="url" id="${inputId}" placeholder="https://..." oninput="handlePhotoUrl(event, ${index})">
          <button onclick="removePhotoInput(${index})" style="background:red; color:white; margin-top:8px;">√ó</button>
        </p>
      `;
    }
    tempPhotos[index] = null;
  }

  function handlePhotoFile(e, index) {
    const file = e.target.files[0];
    if (!file) {
      tempPhotos[index] = null;
      document.getElementById(`photo-name-${index}`).textContent = "Sin archivo seleccionado";
      return;
    }
    const reader = new FileReader();
    reader.onload = () => {
      tempPhotos[index] = reader.result;
      document.getElementById(`photo-name-${index}`).textContent = file.name;
    };
    reader.readAsDataURL(file);
  }

  function handlePhotoUrl(e, index) {
    tempPhotos[index] = e.target.value.trim();
  }

  function removePhotoInput(index) {
    const container = document.getElementById('dynamic-photo-inputs');
    const element = container.children[index];
    if (element) {
      element.remove();
      tempPhotos[index] = 'DELETED';
    }
  }

  function closeAddPhotoModal() {
    document.getElementById('add-photo-modal').style.display = 'none';
  }

  function savePhotos() {
    const validPhotos = tempPhotos.filter(p => p && p !== 'DELETED');
    if (validPhotos.length === 0) return alert("A√±ade al menos una foto (archivo o URL)");
    
    if (!profileData.photos) profileData.photos = [];
    profileData.photos.push(...validPhotos);
    saveProfile();
    renderPhotos();
    closeAddPhotoModal();
  }

  function renderFriends() {
    const container = document.getElementById('friends-container');
    if (!profileData.friends || profileData.friends.length === 0) {
      container.innerHTML = '';
      return;
    }
    container.innerHTML = profileData.friends.map((f, i) => `
      <div class="friend-item">
        ${isEditor ? `
          <button class="edit-btn" onclick="openAddFriendModal(${i})">‚úèÔ∏è</button>
          <button onclick="deleteFriend(${i})">√ó</button>
        ` : ''}
        <img src="${f.pic || 'https://via.placeholder.com/110?text=Amigo'}">
        <div class="friend-name">
          ${f.name}
          ${f.verified ? `<span class="friend-badge">‚òëÔ∏è</span>` : ''}
        </div>
      </div>
    `).join('');
  }

  function deleteFriend(index) {
    if (confirm('¬øEliminar este amigo? Si este amigo ten√≠a comentarios, ser√°n convertidos a un personaje para mantenerlos.')) {
      const friend = profileData.friends[index];
      
      profileData.posts.forEach(post => {
        if (post.commentsData) {
          const needsConversion = hasCommentsFromFriend(post.commentsData, index);
          
          if (needsConversion) {
            if (!profileData.characters) profileData.characters = [];
            profileData.characters.push({
              name: friend.name,
              pic: friend.pic,
              verified: friend.verified,
              fromFriend: true
            });
            
            convertFriendToCharacter(post.commentsData, index, profileData.characters.length - 1);
          }
        }
      });
      
      profileData.posts.forEach(post => {
        if (post.commentsData) {
          decrementFriendIndices(post.commentsData, index);
        }
      });
      
      profileData.friends.splice(index, 1);
      saveProfile();
      renderFriends();
      renderPosts();
    }
  }

  function hasCommentsFromFriend(comments, friendIndex) {
    for (let comment of comments) {
      if (comment.friendIndex === friendIndex) return true;
      if (comment.replies && hasCommentsFromFriend(comment.replies, friendIndex)) return true;
    }
    return false;
  }

  function convertFriendToCharacter(comments, friendIndex, newCharIndex) {
    comments.forEach(comment => {
      if (comment.friendIndex === friendIndex) {
        comment.characterIndex = newCharIndex;
        delete comment.friendIndex;
        delete comment.isFriend;
      }
      if (comment.replies) {
        convertFriendToCharacter(comment.replies, friendIndex, newCharIndex);
      }
    });
  }

  function decrementFriendIndices(comments, deletedIndex) {
    comments.forEach(comment => {
      if (comment.friendIndex !== undefined && comment.friendIndex > deletedIndex) {
        comment.friendIndex -= 1;
      }
      if (comment.replies) {
        decrementFriendIndices(comment.replies, deletedIndex);
      }
    });
  }

  function renderPosts() {
    const { name, profilePic, badge, friends, characters, styles } = profileData;

    document.getElementById('posts-container').innerHTML = profileData.posts.map((post, i) => {
      const hasReactions = post.reactions && post.reactions.trim() !== '';
      const hasComments = post.comments && post.comments.trim() !== '';
      const hasShares = post.shares && post.shares.trim() !== '';
      const showBar = hasReactions || hasComments || hasShares;
      
      const reactionEmojis = (post.reactionEmojis && post.reactionEmojis.trim() !== '') ? post.reactionEmojis : 'üëçüíñüòÜ';
      const emojisArray = Array.from(reactionEmojis).slice(0, 3);
      
      const commentsHtml = renderCommentsRecursive(post.commentsData || [], name, profilePic, badge, friends, characters, styles, i);

      return `
      <div class="post">
        <div class="post-header">
          <img src="${profilePic || 'https://via.placeholder.com/40'}" alt="">
          <div>
            <div class="post-author">
              ${name || 'Usuario'}
              ${badge ? `<img class="badge" src="${badge}" style="width:18px;height:18px;">` : ''}
            </div>
            <div class="post-time" contenteditable="${isEditor}" oninput="updatePostTime(${i}, this.textContent)">${post.time || "Ahora mismo"} ¬∑ üåê</div>
          </div>
          ${isEditor ? `
            <button style="margin-left:auto;background:none;border:none;font-size:24px;cursor:pointer;" onclick="deletePost(${i})">√ó</button>
          ` : ''}
        </div>
        <div class="post-content" contenteditable="${isEditor}" oninput="updatePostContent(${i}, this.innerHTML)">${post.text}</div>
        ${post.image ? `<img src="${post.image}" class="post-image" onclick="${isEditor ? `openPostImageModal(${i})` : ''}">` : ''}

        ${showBar ? `
        <div class="reactions-bar">
          <div class="reaction-summary" onclick="${isEditor ? `openReactionsModal(${i})` : ''}" style="cursor:${isEditor ? 'pointer' : 'default'};">
            ${hasReactions ? `
              <div class="reaction-icons">
                ${emojisArray.map(emoji => `<span>${emoji}</span>`).join('')}
              </div>
              <span class="reaction-count">${post.reactions}</span>
            ` : ''}
          </div>
          <div style="display: flex; align-items: center; gap: 8px;">
            ${isEditor ? `
              <input type="text" class="reaction-emojis-input" value="${reactionEmojis}" oninput="updateReactionEmojis(${i}, this.value)" placeholder="üëç‚ù§Ô∏èüòÜ" maxlength="10">
            ` : ''}
            <div class="comments-shares" onclick="${isEditor ? `openReactionsModal(${i})` : ''}" style="cursor:${isEditor ? 'pointer' : 'default'};">
              ${hasComments ? `${post.comments} comentario${post.comments === '1' ? '' : 's'}` : ''}
              ${hasComments && hasShares ? ' ¬∑ ' : ''}
              ${hasShares ? `${post.shares} compartido${post.shares === '1' ? '' : 's'}` : ''}
            </div>
          </div>
        </div>
        ` : (isEditor ? `
        <div class="reactions-bar" onclick="openReactionsModal(${i})" style="cursor:pointer; justify-content:center; color:#65676b;">
          <span>+ A√±adir reacciones</span>
        </div>
        ` : '')}

        ${commentsHtml.length > 0 ? `
        <div class="comments-section visible">
          ${commentsHtml}
          ${isEditor ? `<button onclick="openCommentsModal(${i})" style="margin-top:8px; font-size:13px; background:var(--fb-gray); padding:6px 12px; border-radius:6px; border:none; cursor:pointer;">Editar comentarios</button>` : ''}
        </div>
        ` : (isEditor ? `
        <div style="padding:12px 16px; border-top:1px solid #e4e6eb;">
          <button onclick="openCommentsModal(${i})" style="font-size:13px; background:var(--fb-gray); padding:6px 12px; border-radius:6px; border:none; cursor:pointer;">+ A√±adir comentarios</button>
        </div>
        ` : '')}
      </div>
    `}).join('');
  }

  function updatePostTime(postIndex, newTime) {
    profileData.posts[postIndex].time = newTime;
    saveProfile();
  }

  function updatePostContent(postIndex, newContent) {
    profileData.posts[postIndex].text = newContent;
    saveProfile();
  }

  function updateReactionEmojis(postIndex, newEmojis) {
    profileData.posts[postIndex].reactionEmojis = newEmojis.trim();
    saveProfile();
  }

  function renderCommentsRecursive(comments, name, profilePic, badge, friends, characters, styles, postIndex, depth = 0) {
    return comments.map((comment, commentIndex) => {
      let commentAuthor = 'Desconocido';
      let commentPic = 'https://via.placeholder.com/32';
      let commentBadge = '';
      
      if (comment.isProfile) {
        commentAuthor = name || 'Mi Perfil';
        commentPic = profilePic || 'https://via.placeholder.com/32';
        commentBadge = badge;
      } else if (comment.friendIndex !== undefined && friends[comment.friendIndex]) {
        const friend = friends[comment.friendIndex];
        commentAuthor = friend.name;
        commentPic = friend.pic;
        commentBadge = friend.verified ? '‚òëÔ∏è' : '';
      } else if (comment.characterIndex !== undefined && characters[comment.characterIndex]) {
        const character = characters[comment.characterIndex];
        commentAuthor = character.name;
        commentPic = character.pic;
        commentBadge = character.verified ? (character.badge || defaultBadges[0]) : '';
      } else {
        commentAuthor = comment.author;
        commentPic = comment.pic;
        commentBadge = comment.badge;
      }

      const repliesHtml = comment.replies ? renderCommentsRecursive(comment.replies, name, profilePic, badge, friends, characters, styles, postIndex, depth + 1) : '';

      return `
        <div class="comment-item" style="margin-left: ${depth * 40}px;">
          <img src="${commentPic}" alt="">
          <div class="comment-bubble">
            <div class="comment-author">
              ${commentAuthor}
              ${commentBadge && typeof commentBadge === 'string' && commentBadge.startsWith('http') ? `<img class="comment-badge" src="${commentBadge}" alt="‚úì">` : (commentBadge ? commentBadge : '')}
            </div>
            <div class="comment-text">${comment.text}</div>
            ${comment.hasHeart ? `<div class="comment-heart">‚ù§Ô∏è</div>` : ''}
          </div>
        </div>
        ${repliesHtml}
      `;
    }).join('');
  }

  function deletePost(index) {
    if (confirm('¬øEliminar esta publicaci√≥n?')) {
      profileData.posts.splice(index, 1);
      saveProfile();
      renderPosts();
    }
  }

  function openReactionsModal(postIndex) {
    if (!isEditor) return;
    currentPostForReactions = postIndex;
    const post = profileData.posts[postIndex];
    document.getElementById('reaction-total').value = post.reactions || '';
    document.getElementById('reaction-comments').value = post.comments || '';
    document.getElementById('reaction-shares').value = post.shares || '';
    document.getElementById('reactions-modal').style.display = 'flex';
  }

  function closeReactionsModal() {
    document.getElementById('reactions-modal').style.display = 'none';
  }

  function saveReactions() {
    if (currentPostForReactions === -1) return;
    const post = profileData.posts[currentPostForReactions];
    post.reactions = document.getElementById('reaction-total').value.trim();
    post.comments = document.getElementById('reaction-comments').value.trim();
    post.shares = document.getElementById('reaction-shares').value.trim();
    saveProfile();
    renderPosts();
    closeReactionsModal();
  }

  function switchTab(tab) {
    currentTab = tab;
    if (tab === 'comments') {
      document.getElementById('comments-tab-content').style.display = 'block';
      document.getElementById('characters-tab-content').style.display = 'none';
      document.getElementById('tab-comments').style.borderBottom = '3px solid var(--fb-blue)';
      document.getElementById('tab-comments').style.fontWeight = '600';
      document.getElementById('tab-characters').style.borderBottom = '3px solid transparent';
      document.getElementById('tab-characters').style.fontWeight = '400';
    } else {
      document.getElementById('comments-tab-content').style.display = 'none';
      document.getElementById('characters-tab-content').style.display = 'block';
      document.getElementById('tab-comments').style.borderBottom = '3px solid transparent';
      document.getElementById('tab-comments').style.fontWeight = '400';
      document.getElementById('tab-characters').style.borderBottom = '3px solid var(--fb-blue)';
      document.getElementById('tab-characters').style.fontWeight = '600';
      renderCharactersList();
    }
  }

  function openCommentsModal(postIndex) {
    if (!isEditor) return;
    currentPostForComments = postIndex;
    const post = profileData.posts[postIndex];
    if (!post.commentsData) post.commentsData = [];
    
    selectedCharacter = null;
    selectedParentCommentPath = null;
    document.getElementById('selected-character-name').textContent = '';
    document.getElementById('parent-comment-indicator').style.display = 'none';
    switchTab('comments');
    renderCommentsTree();
    document.getElementById('comments-modal').style.display = 'flex';
  }

  function renderCommentsTree() {
    const post = profileData.posts[currentPostForComments];
    const { friends, characters, name, profilePic, badge } = profileData;

    function renderTree(comments, path = []) {
      return comments.map((comment, i) => {
        const currentPath = [...path, i];
        const pathString = currentPath.join('-');
        
        let commentAuthor = 'Desconocido';
        let commentPic = 'https://via.placeholder.com/32';
        let commentBadge = '';
        
        if (comment.isProfile) {
          commentAuthor = name || 'Mi Perfil';
          commentPic = profilePic || 'https://via.placeholder.com/32';
          commentBadge = badge;
        } else if (comment.friendIndex !== undefined && friends[comment.friendIndex]) {
          const friend = friends[comment.friendIndex];
          commentAuthor = friend.name;
          commentPic = friend.pic;
          commentBadge = friend.verified ? '‚òëÔ∏è' : '';
        } else if (comment.characterIndex !== undefined && characters[comment.characterIndex]) {
          const character = characters[comment.characterIndex];
          commentAuthor = character.name;
          commentPic = character.pic;
          commentBadge = character.verified ? (character.badge || defaultBadges[0]) : '';
        }

        const repliesHtml = comment.replies ? renderTree(comment.replies, currentPath) : '';

        return `
          <div class="comment-tree-item ${path.length > 0 ? 'reply' : ''}">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
              <img src="${commentPic}" style="width:32px; height:32px; border-radius:50%;" alt="">
              <strong>${commentAuthor}</strong>
              ${commentBadge && typeof commentBadge === 'string' && commentBadge.startsWith('http') ? `<img src="${commentBadge}" width="14" style="border-radius:50%;">` : (commentBadge ? commentBadge : '')}
              ${comment.hasHeart ? `<span>‚ù§Ô∏è</span>` : ''}
            </div>
            <div style="padding-left:40px; margin-bottom:8px;">${comment.text}</div>
            <div class="comment-controls" style="padding-left:40px;">
              <button onclick="toggleCommentHeart('${pathString}')" style="background:${comment.hasHeart ? '#e74c3c' : '#ddd'}; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:11px;">‚ù§Ô∏è</button>
              <button onclick="setParentComment('${pathString}', '${commentAuthor.replace(/'/g, "\\'")}', ${currentPath.length})" style="background:var(--fb-blue); color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:11px;">Responder</button>
              <button onclick="removeComment('${pathString}')" style="background:red; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:11px;">Eliminar</button>
            </div>
            ${repliesHtml}
          </div>
        `;
      }).join('');
    }

    document.getElementById('comments-tree').innerHTML = renderTree(post.commentsData);
    document.getElementById('new-comment-text').value = '';
  }

  function getCommentByPath(comments, path) {
    let current = comments;
    for (let i = 0; i < path.length; i++) {
      if (!current[path[i]]) return null;
      if (i === path.length - 1) return current[path[i]];
      current = current[path[i]].replies || [];
    }
    return null;
  }

  function toggleCommentHeart(pathString) {
    const path = pathString.split('-').map(Number);
    const post = profileData.posts[currentPostForComments];
    const comment = getCommentByPath(post.commentsData, path);
    if (comment) {
      comment.hasHeart = !comment.hasHeart;
      saveProfile();
      renderCommentsTree();
    }
  }

  function setParentComment(pathString, authorName, depth) {
    selectedParentCommentPath = pathString;
    document.getElementById('parent-comment-indicator').style.display = 'block';
    document.getElementById('parent-comment-name').textContent = authorName;
  }

  function cancelParentSelection() {
    selectedParentCommentPath = null;
    document.getElementById('parent-comment-indicator').style.display = 'none';
  }

  function removeComment(pathString) {
    if (!confirm('¬øEliminar este comentario y todas sus respuestas?')) return;
    
    const path = pathString.split('-').map(Number);
    const post = profileData.posts[currentPostForComments];
    
    let current = post.commentsData;
    for (let i = 0; i < path.length - 1; i++) {
      current = current[path[i]].replies;
    }
    
    current.splice(path[path.length - 1], 1);
    saveProfile();
    renderCommentsTree();
  }

  function openCharacterSelector() {
    renderCharacterSelectorList();
    document.getElementById('character-selector-modal').style.display = 'flex';
  }

  function renderCharacterSelectorList() {
    const profileChar = {
      name: profileData.name || 'Mi Perfil',
      pic: profileData.profilePic || 'https://via.placeholder.com/40',
      badge: profileData.badge,
      type: 'profile'
    };

    const friendChars = (profileData.friends || []).map((f, idx) => ({
      name: f.name,
      pic: f.pic,
      verified: f.verified,
      type: 'friend',
      index: idx
    }));

    const customChars = (profileData.characters || []).map((c, idx) => ({
      name: c.name,
      pic: c.pic,
      verified: c.verified,
      type: 'character',
      index: idx
    }));

    const allChars = [profileChar, ...friendChars, ...customChars];

    document.getElementById('character-selector-list').innerHTML = allChars.map((char, i) => {
      let infoText = '';
      let className = '';
      if (char.type === 'profile') {
        infoText = '<span style="color:var(--fb-blue); font-size:12px; margin-left:8px;">(Tu perfil)</span>';
        className = 'profile-character';
      } else if (char.type === 'friend') {
        infoText = '<span style="color:#65676b; font-size:12px; margin-left:8px;">(Amigo)</span>';
        className = 'friend-character';
      } else if (char.fromFriend) {
        infoText = '<span style="color:#65676b; font-size:12px; margin-left:8px;">(Personaje - antes amigo)</span>';
      }

      let badgeDisplay = '';
      if (char.type === 'profile' && char.badge) {
        badgeDisplay = `<img src="${char.badge}" width="12" style="border-radius:50%; margin-left:4px; vertical-align:middle;">`;
      } else if (char.type === 'friend' && char.verified) {
        badgeDisplay = '<span style="margin-left:4px;">‚òëÔ∏è</span>';
      } else if (char.type === 'character' && char.verified) {
        badgeDisplay = `<img src="${defaultBadges[0]}" width="12" style="border-radius:50%; margin-left:4px; vertical-align:middle;">`;
      }

      return `
        <div class="character-item ${className}" onclick="selectCharacterForComment(${i})">
          <img src="${char.pic}" alt="">
          <div style="flex:1;">
            <strong>${char.name}</strong>
            ${badgeDisplay}
            ${infoText}
          </div>
        </div>
      `;
    }).join('');
  }

  function selectCharacterForComment(index) {
    const profileChar = {
      name: profileData.name || 'Mi Perfil',
      pic: profileData.profilePic || 'https://via.placeholder.com/32',
      badge: profileData.badge,
      type: 'profile'
    };

    const friendChars = (profileData.friends || []).map((f, idx) => ({
      name: f.name,
      pic: f.pic,
      verified: f.verified,
      type: 'friend',
      index: idx
    }));

    const customChars = (profileData.characters || []).map((c, idx) => ({
      name: c.name,
      pic: c.pic,
      verified: c.verified,
      type: 'character',
      index: idx
    }));
    
    const allChars = [profileChar, ...friendChars, ...customChars];
    
    selectedCharacter = allChars[index];
    document.getElementById('selected-character-name').textContent = selectedCharacter.name;
    closeCharacterSelector();
  }

  function closeCharacterSelector() {
    document.getElementById('character-selector-modal').style.display = 'none';
  }

  function addCommentToPost() {
    if (!selectedCharacter) return alert("Selecciona un personaje primero");
    
    const text = document.getElementById('new-comment-text').value.trim();
    if (!text) return alert("Escribe un comentario");
    
    const post = profileData.posts[currentPostForComments];
    if (!post.commentsData) post.commentsData = [];
    
    const commentData = {
      text: text,
      isProfile: selectedCharacter.type === 'profile' ? true : undefined,
      friendIndex: selectedCharacter.type === 'friend' ? selectedCharacter.index : undefined,
      characterIndex: selectedCharacter.type === 'character' ? selectedCharacter.index : undefined,
      hasHeart: false,
      replies: []
    };
    
    if (selectedParentCommentPath) {
      const path = selectedParentCommentPath.split('-').map(Number);
      const parentComment = getCommentByPath(post.commentsData, path);
      if (parentComment) {
        if (!parentComment.replies) parentComment.replies = [];
        parentComment.replies.push(commentData);
      }
      cancelParentSelection();
    } else {
      post.commentsData.push(commentData);
    }
    
    saveProfile();
    renderCommentsTree();
    selectedCharacter = null;
    document.getElementById('selected-character-name').textContent = '';
    document.getElementById('new-comment-text').value = '';
  }

  function renderCharactersList() {
    const { friends, characters, name, profilePic, badge } = profileData;

    const profileChar = {
      name: name || 'Mi Perfil',
      pic: profilePic || 'https://via.placeholder.com/40',
      badge: badge,
      type: 'profile'
    };

    const friendChars = (friends || []).map(f => ({
      name: f.name,
      pic: f.pic,
      verified: f.verified,
      type: 'friend'
    }));

    const customChars = characters || [];

    const allChars = [profileChar, ...friendChars, ...customChars];
    const friendCount = friendChars.length;
    let customCharIndex = 0;

    document.getElementById('characters-list').innerHTML = allChars.map((char, i) => {
      if (char.type === 'profile') {
        return `
          <div class="character-item profile-character">
            <img src="${char.pic}" alt="">
            <div style="flex:1;">
              <strong>${char.name}</strong>
              ${char.badge ? `<img src="${char.badge}" width="14" style="border-radius:50%; margin-left:4px; vertical-align:middle;">` : ''}
              <div style="color:var(--fb-blue); font-size:12px;">Tu perfil (se actualiza autom√°ticamente)</div>
            </div>
          </div>
        `;
      } else if (char.type === 'friend') {
        return `
          <div class="character-item friend-character">
            <img src="${char.pic}" alt="">
            <div style="flex:1;">
              <strong>${char.name}</strong>
              ${char.verified ? '<span style="margin-left:4px;">‚òëÔ∏è</span>' : ''}
              <div style="color:#65676b; font-size:12px;">Amigo (se actualiza autom√°ticamente - edita en la secci√≥n Amigos)</div>
            </div>
          </div>
        `;
      } else {
        const realIndex = customCharIndex;
        customCharIndex++;
        return `
          <div class="character-item">
            <img src="${char.pic}" alt="">
            <div style="flex:1;">
              <strong>${char.name}</strong>
              ${char.verified ? `<img src="${defaultBadges[0]}" width="14" style="border-radius:50%; margin-left:4px; vertical-align:middle;">` : ''}
              ${char.fromFriend ? '<div style="color:#65676b; font-size:12px;">(Personaje independiente - antes era amigo)</div>' : ''}
            </div>
            <button onclick="deleteCharacter(${realIndex})" style="background:red; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">Eliminar</button>
          </div>
        `;
      }
    }).join('');
    
    tempCharPic = null;
    document.getElementById('new-char-pic-name').textContent = 'Sin foto';
    document.getElementById('char-verified').checked = false;
  }

  function saveCharacter() {
    const name = document.getElementById('new-char-name').value.trim();
    const verified = document.getElementById('char-verified').checked;
    
    if (!name) return alert("Escribe un nombre para el personaje");
    if (!tempCharPic) return alert("A√±ade una foto (archivo o URL) para el personaje");
    
    if (!profileData.characters) profileData.characters = [];
    
    profileData.characters.push({
      name: name,
      pic: tempCharPic,
      verified: verified,
      fromFriend: false
    });
    
    document.getElementById('new-char-name').value = '';
    tempCharPic = null;
    document.getElementById('new-char-pic-name').textContent = 'Sin foto';
    document.getElementById('char-verified').checked = false;
    
    saveProfile();
    renderCharactersList();
    alert('Personaje guardado correctamente');
  }

  function deleteCharacter(index) {
    if (confirm('¬øEliminar este personaje? Todos sus comentarios quedar√°n como "Desconocido".')) {
      profileData.posts.forEach(post => {
        if (post.commentsData) {
          removeCharacterFromComments(post.commentsData, index);
        }
      });
      
      profileData.characters.splice(index, 1);
      saveProfile();
      renderCharactersList();
      renderPosts();
    }
  }

  function removeCharacterFromComments(comments, charIndex) {
    for (let i = comments.length - 1; i >= 0; i--) {
      const comment = comments[i];
      if (comment.characterIndex !== undefined) {
        if (comment.characterIndex === charIndex) {
          comments.splice(i, 1);
        } else if (comment.characterIndex > charIndex) {
          comment.characterIndex -= 1;
        }
      }
      if (comment.replies) {
        removeCharacterFromComments(comment.replies, charIndex);
      }
    }
  }

  function closeCommentsModal() {
    document.getElementById('comments-modal').style.display = 'none';
    renderPosts();
  }

  function openAddFriendModal(index) {
    editingFriendIndex = index;
    document.getElementById('add-friend-modal').style.display = 'flex';
    
    let friend = null;
    if (index === -1) {
      document.getElementById('friend-modal-title').textContent = 'A√±adir Amigo';
      tempFriendPic = null;
      document.getElementById('friend-name').value = "";
      document.getElementById('friend-verified').checked = false;
    } else {
      document.getElementById('friend-modal-title').textContent = 'Editar Amigo';
      friend = profileData.friends[index];
      document.getElementById('friend-name').value = friend.name;
      tempFriendPic = friend.pic;
      document.getElementById('friend-verified').checked = friend.verified || false;
    }
    
    document.getElementById('friend-pic-name').textContent = tempFriendPic ? "Foto actual" : "Sin foto";
  }

  function closeAddFriendModal() {
    document.getElementById('add-friend-modal').style.display = 'none';
    editingFriendIndex = -1;
  }

  function saveFriend() {
    const name = document.getElementById('friend-name').value.trim();
    const verified = document.getElementById('friend-verified').checked;
    if (!name) return alert("Escribe un nombre");
    if (!profileData.friends) profileData.friends = [];
    
    const friendData = {
      name,
      pic: tempFriendPic || "https://via.placeholder.com/110?text=" + name[0],
      verified: verified
    };
    
    if (editingFriendIndex === -1) {
      profileData.friends.push(friendData);
    } else {
      profileData.friends[editingFriendIndex] = friendData;
    }
    
    saveProfile();
    renderFriends();
    renderPosts();
    closeAddFriendModal();
  }

  function createNewPost() {
    const text = document.getElementById('new-post-text').value.trim();
    if (!text && !tempPostImage) return alert('Escribe algo o a√±ade una foto');
    
    if (!profileData.posts) profileData.posts = [];
    
    profileData.posts.unshift({
      text: text.replace(/@([\w√°√©√≠√≥√∫√±]+)/gi, '<a href="#">@$1</a>'),
      image: tempPostImage,
      reactions: '',
      comments: '',
      shares: '',
      reactionEmojis: 'üëçüíñüòÜ',
      commentsData: [],
      time: "Ahora mismo"
    });
    
    tempPostImage = null;
    document.getElementById('new-post-text').value = '';
    saveProfile();
    renderPosts();
  }
  
  // IMAGEN UPLOAD MODAL CON RECORTE
  
  function openImageUploadModal(target, postIndex = -1) {
    currentImageTarget = target;
    currentImageSourceType = 'file';
    currentImagePreviewData = null;
    currentImageCallback = null;
    cropMode = false;
    
    document.getElementById('image-preview').style.display = 'none';
    document.getElementById('crop-section').style.display = 'none';
    document.getElementById('simple-preview-section').style.display = 'block';
    document.getElementById('enable-crop-btn').style.display = 'none';
    document.getElementById('use-default-btn').style.display = 'none';
    
    document.getElementById('generic-file-input').value = '';
    document.getElementById('generic-url-input').value = '';
    document.getElementById('file-name-preview').textContent = 'Sin archivo seleccionado';

    if (target === 'cover') {
        document.getElementById('image-upload-title').textContent = 'Cambiar Portada';
        currentImagePreviewData = profileData.cover;
        currentImageCallback = src => { profileData.cover = src; saveProfile(); renderAll(); };
    } else if (target === 'profilePic') {
        document.getElementById('image-upload-title').textContent = 'Cambiar Foto de Perfil';
        currentImagePreviewData = profileData.profilePic;
        currentImageCallback = src => { profileData.profilePic = src; saveProfile(); renderAll(); };
    } else if (target === 'newPostImage') {
        document.getElementById('image-upload-title').textContent = 'A√±adir Foto al Post';
        currentImagePreviewData = tempPostImage;
        currentImageCallback = src => { tempPostImage = src; alert('Imagen seleccionada. Ahora escribe tu texto y presiona Publicar.'); closeImageUploadModal(); };
    } else if (target === 'editPostImage') {
        document.getElementById('image-upload-title').textContent = 'Editar Foto del Post';
        currentPostForReactions = postIndex;
        const post = profileData.posts[postIndex];
        currentImagePreviewData = post.image;
        currentImageCallback = src => { post.image = src; saveProfile(); renderPosts(); closeImageUploadModal(); };
    } else if (target === 'friend') {
        document.getElementById('image-upload-title').textContent = 'Cambiar Foto de Amigo';
        currentImagePreviewData = tempFriendPic;
        currentImageCallback = src => { tempFriendPic = src; document.getElementById('friend-pic-name').textContent = "Foto seleccionada"; closeImageUploadModal(); };
    } else if (target === 'character') {
        document.getElementById('image-upload-title').textContent = 'Cambiar Foto de Personaje';
        currentImagePreviewData = tempCharPic;
        currentImageCallback = src => { tempCharPic = src; document.getElementById('new-char-pic-name').textContent = "Foto seleccionada"; closeImageUploadModal(); };
    }
    
    switchImageInput('file');
    if (currentImagePreviewData) {
        document.getElementById('image-preview').src = currentImagePreviewData;
        document.getElementById('image-preview').style.display = 'block';
    }

    document.getElementById('image-upload-modal').style.display = 'flex';
  }
  
  function openPostImageModal(target, index = -1) {
    if (target === 'new') {
        openImageUploadModal('newPostImage');
    } else {
        openImageUploadModal('editPostImage', index);
    }
  }

  function switchImageInput(type) {
      currentImageSourceType = type;
      document.getElementById('file-input-section').style.display = type === 'file' ? 'block' : 'none';
      document.getElementById('url-input-section').style.display = type === 'url' ? 'block' : 'none';
      
      document.getElementById('btn-file-input').style.background = type === 'file' ? 'var(--fb-blue)' : '#ddd';
      document.getElementById('btn-url-input').style.background = type === 'url' ? 'var(--fb-blue)' : '#ddd';
      document.getElementById('btn-file-input').style.color = type === 'file' ? 'white' : 'var(--text)';
      document.getElementById('btn-url-input').style.color = type === 'url' ? 'white' : 'var(--text)';
      
      if (type === 'file') {
          document.getElementById('generic-url-input').value = '';
      } else {
          document.getElementById('generic-file-input').value = '';
          document.getElementById('file-name-preview').textContent = 'Sin archivo seleccionado';
      }
      document.getElementById('image-preview').style.display = 'none';
      document.getElementById('crop-section').style.display = 'none';
      document.getElementById('simple-preview-section').style.display = 'block';
      document.getElementById('enable-crop-btn').style.display = 'none';
      document.getElementById('use-default-btn').style.display = 'none';
      cropMode = false;
  }

  function previewFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      document.getElementById('file-name-preview').textContent = file.name;
      const reader = new FileReader();
      reader.onload = () => {
          currentImagePreviewData = reader.result;
          cropOriginalImage = reader.result;
          document.getElementById('image-preview').src = currentImagePreviewData;
          document.getElementById('image-preview').style.display = 'block';
          document.getElementById('enable-crop-btn').style.display = 'inline-block';
      };
      reader.readAsDataURL(file);
  }

  function previewUrl(e) {
      currentImagePreviewData = e.target.value.trim();
      cropOriginalImage = currentImagePreviewData;
      document.getElementById('image-preview').src = currentImagePreviewData;
      document.getElementById('image-preview').style.display = currentImagePreviewData ? 'block' : 'none';
      if (currentImagePreviewData) {
          document.getElementById('enable-crop-btn').style.display = 'inline-block';
      } else {
          document.getElementById('enable-crop-btn').style.display = 'none';
      }
  }

  function enableCropMode() {
      if (!currentImagePreviewData) return alert('Primero selecciona una imagen');
      
      cropMode = true;
      cropX = 0;
      cropY = 0;
      cropZoom = 100;
      
      document.getElementById('simple-preview-section').style.display = 'none';
      document.getElementById('crop-section').style.display = 'block';
      document.getElementById('enable-crop-btn').style.display = 'none';
      document.getElementById('use-default-btn').style.display = 'inline-block';
      
      const cropCanvas = document.getElementById('crop-canvas');
      cropCanvas.src = cropOriginalImage;
      document.getElementById('zoom-slider').value = 100;
      
      cropCanvas.onload = () => {
          resetCrop();
      };
      
      setupCropHandlers();
  }

  function setupCropHandlers() {
      const wrapper = document.getElementById('crop-canvas-wrapper');
      const canvas = document.getElementById('crop-canvas');
      
      canvas.onmousedown = (e) => {
          isDragging = true;
          startDragX = e.clientX - cropX;
          startDragY = e.clientY - cropY;
          e.preventDefault();
      };
      
      canvas.ontouchstart = (e) => {
          isDragging = true;
          const touch = e.touches[0];
          startDragX = touch.clientX - cropX;
          startDragY = touch.clientY - cropY;
          e.preventDefault();
      };
      
      document.onmousemove = (e) => {
          if (!isDragging) return;
          cropX = e.clientX - startDragX;
          cropY = e.clientY - startDragY;
          updateCropPosition();
      };
      
      document.ontouchmove = (e) => {
          if (!isDragging) return;
          const touch = e.touches[0];
          cropX = touch.clientX - startDragX;
          cropY = touch.clientY - startDragY;
          updateCropPosition();
      };
      
      document.onmouseup = () => {
          isDragging = false;
      };
      
      document.ontouchend = () => {
          isDragging = false;
      };
  }

  function updateCropPosition() {
      const canvas = document.getElementById('crop-canvas');
      canvas.style.left = cropX + 'px';
      canvas.style.top = cropY + 'px';
  }

  function updateZoom(value) {
      cropZoom = parseInt(value);
      const canvas = document.getElementById('crop-canvas');
      canvas.style.width = cropZoom + '%';
      canvas.style.height = 'auto';
  }

  function resetCrop() {
      cropX = 0;
      cropY = 0;
      cropZoom = 100;
      document.getElementById('zoom-slider').value = 100;
      const canvas = document.getElementById('crop-canvas');
      canvas.style.left = '0px';
      canvas.style.top = '0px';
      canvas.style.width = '100%';
      canvas.style.height = 'auto';
  }

  function closeImageUploadModal() {
      document.getElementById('image-upload-modal').style.display = 'none';
      cropMode = false;
      isDragging = false;
  }

  function saveImage() {
      if (!currentImagePreviewData || currentImagePreviewData.trim() === '') {
          return alert(currentImageSourceType === 'file' ? 'Selecciona un archivo' : 'Pega un link/URL');
      }
      
      if (cropMode) {
          const wrapper = document.getElementById('crop-canvas-wrapper');
          const canvas = document.getElementById('crop-canvas');
          
          const tempCanvas = document.createElement('canvas');
          const ctx = tempCanvas.getContext('2d');
          
          const wrapperWidth = wrapper.offsetWidth;
          const wrapperHeight = wrapper.offsetHeight;
          
          tempCanvas.width = wrapperWidth;
          tempCanvas.height = wrapperHeight;
          
          const img = new Image();
          img.onload = () => {
              const scale = cropZoom / 100;
              const scaledWidth = img.width * scale;
              const scaledHeight = img.height * scale;
              
              ctx.drawImage(img, cropX, cropY, scaledWidth, scaledHeight);
              
              const croppedImage = tempCanvas.toDataURL('image/png');
              
              if (currentImageCallback) {
                  currentImageCallback(croppedImage);
              }
              
              closeImageUploadModal();
          };
          img.src = cropOriginalImage;
      } else {
          if (currentImageCallback) {
              currentImageCallback(currentImagePreviewData);
          }
          
          closeImageUploadModal();
      }
  }
  
  // ESTILOS
  
  const styleElements = [
    { id: 'fontFamilyProfile', name: 'Nombre de Perfil (Fuente)', type: 'font' },
    { id: 'fontSizeProfile', name: 'Nombre de Perfil (Tama√±o)', type: 'size' },
    { id: 'fontFamilyFollowers', name: 'Seguidores (Fuente)', type: 'font' },
    { id: 'fontSizeFollowers', name: 'Seguidores (Tama√±o)', type: 'size' },
    { id: 'fontFamilyInfo', name: 'Informaci√≥n (Fuente)', type: 'font' },
    { id: 'fontSizeInfo', name: 'Informaci√≥n (Tama√±o)', type: 'size' },
    { id: 'fontFamilyPostText', name: 'Post Texto (Fuente)', type: 'font' },
    { id: 'fontSizePostText', name: 'Post Texto (Tama√±o)', type: 'size' },
    { id: 'fontFamilyPostTime', name: 'Post Hora (Fuente)', type: 'font' },
    { id: 'fontSizePostTime', name: 'Post Hora (Tama√±o)', type: 'size' },
    { id: 'fontFamilyComment', name: 'Comentario (Fuente)', type: 'font' },
    { id: 'fontSizeComment', name: 'Comentario (Tama√±o)', type: 'size' },
    { id: 'fontFamilyFriend', name: 'Amigo (Fuente)', type: 'font' },
    { id: 'fontSizeFriend', name: 'Amigo (Tama√±o)', type: 'size' },
  ];

  function openStyleModal() {
    const container = document.getElementById('style-controls');
    
    const grouped = {};
    styleElements.forEach(item => {
      const base = item.id.replace(/^(fontFamily|fontSize)/, '');
      if (!grouped[base]) grouped[base] = [];
      grouped[base].push(item);
    });
    
    container.innerHTML = Object.keys(grouped).map(base => {
      const items = grouped[base];
      return `
        <div class="style-control-group">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <h4 style="margin:0;">${items[0].name.split(' (')[0]}</h4>
            <button onclick="resetStyleGroup('${base}')" style="background:#e74c3c; color:white; font-size:11px; padding:4px 8px;">Restablecer</button>
          </div>
          ${items.map(item => {
            let inputHtml;
            const currentValue = profileData.styles[item.id] || '';
            
            if (item.type === 'font') {
              inputHtml = `
                <input type="text" id="${item.id}" value="${currentValue}" list="font-datalist" style="width:100%;">
              `;
            } else {
              const sizeValue = currentValue.replace('px', '');
              inputHtml = `
                <input type="number" id="${item.id}" value="${sizeValue}" min="8" max="72" style="width:80%; display:inline;"> px
              `;
            }
            
            return `
              <p style="margin-bottom:8px;">
                <label style="display:block; font-weight:500; margin-bottom:4px; font-size:13px;">${item.type === 'font' ? 'Fuente' : 'Tama√±o'}:</label>
                ${inputHtml}
              </p>
            `;
          }).join('')}
        </div>
      `;
    }).join('') + `
      <datalist id="font-datalist">
        ${FONT_OPTIONS.map(font => `<option value="${font}"></option>`).join('')}
      </datalist>
    `;
    
    document.getElementById('style-modal').style.display = 'flex';
  }

  function resetStyleGroup(base) {
    const items = styleElements.filter(item => item.id.includes(base));
    items.forEach(item => {
      profileData.styles[item.id] = DEFAULT_STYLES[item.id];
      const el = document.getElementById(item.id);
      if (el) {
        if (item.type === 'size') {
          el.value = DEFAULT_STYLES[item.id].replace('px', '');
        } else {
          el.value = DEFAULT_STYLES[item.id];
        }
      }
    });
    applyStylesToCSS();
    saveProfile();
    renderAll();
  }

  function resetAllStyles() {
    if (!confirm('¬øRestablecer todos los estilos a los valores predeterminados?')) return;
    
    profileData.styles = {...DEFAULT_STYLES};
    applyStylesToCSS();
    saveProfile();
    openStyleModal();
    renderAll();
  }

  function closeStyleModal() {
    document.getElementById('style-modal').style.display = 'none';
  }

  function applyStyles() {
    styleElements.forEach(item => {
      let value = document.getElementById(item.id).value.trim();
      
      if (item.type === 'size') {
        if (value && !isNaN(parseInt(value))) {
          value = `${parseInt(value)}px`;
        } else {
            value = profileData.styles[item.id];
        }
      }
      
      profileData.styles[item.id] = value;
    });
    
    applyStylesToCSS();
    saveProfile();
    renderAll();
    closeStyleModal();
  }
  
  function applyStylesToCSS() {
      const styleEl = document.documentElement.style;
      for (const key in profileData.styles) {
          if (profileData.styles.hasOwnProperty(key)) {
              const cssVar = `--${key.replace(/([a-z0-9]|(?=[A-Z]))([A-Z])/g, '$1-$2').toLowerCase()}`;
              styleEl.setProperty(cssVar, profileData.styles[key]);
          }
      }
  }

  function saveProfile() {
    localStorage.setItem('fbProfile2025', JSON.stringify(profileData));
  }

  function loadProfile() {
    const saved = localStorage.getItem('fbProfile2025');
    if (saved) {
      try {
        const loadedData = JSON.parse(saved);
        
        if (!loadedData.styles) {
            loadedData.styles = {...DEFAULT_STYLES};
        } else {
            profileData.styles = { ...DEFAULT_STYLES, ...loadedData.styles };
            loadedData.styles = profileData.styles;
        }

        if (loadedData.friends) {
          loadedData.friends.forEach(friend => {
            if (friend.badge && !friend.verified) {
              friend.verified = true;
            }
            delete friend.badge;
          });
        }

        if (loadedData.characters) {
          loadedData.characters.forEach(char => {
            if (char.badge && !char.verified) {
              char.verified = true;
            }
          });
        }

        if (loadedData.posts) {
            loadedData.posts.forEach(post => {
                if (!post.reactionEmojis) post.reactionEmojis = 'üëçüíñüòÜ';
                if (post.commentsData) {
                    processCommentsForCompatibility(post.commentsData);
                }
            });
        }
        
        profileData = {
          name: loadedData.name || "",
          profilePic: loadedData.profilePic || "",
          cover: loadedData.cover || "",
          badge: loadedData.badge || "",
          followers: loadedData.followers || "",
          info: loadedData.info || "",
          infoDetails: loadedData.infoDetails || "",
          photos: loadedData.photos || [],
          friends: loadedData.friends || [],
          posts: loadedData.posts || [],
          characters: loadedData.characters || [],
          styles: loadedData.styles
        };
        
      } catch (e) {
        console.error('Error al cargar perfil:', e);
      }
    }
  }

  function processCommentsForCompatibility(comments) {
    comments.forEach(comment => {
      if (!comment.hasHeart) comment.hasHeart = false;
      if (!comment.replies) comment.replies = [];
      if (comment.isProfile || comment.friendIndex !== undefined || comment.characterIndex !== undefined) {
        delete comment.author;
        delete comment.pic;
        delete comment.badge;
      }
      if (comment.replies) {
        processCommentsForCompatibility(comment.replies);
      }
    });
  }

  function exportProfile() {
    const data = JSON.stringify(profileData, null, 2);
    const blob = new Blob([data], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'perfil-fakebook.json';
    a.click();
    URL.revokeObjectURL(url);
  }

  function importProfile(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        let importedData = JSON.parse(ev.target.result);
        
        if (!importedData.styles) {
            importedData.styles = {...DEFAULT_STYLES};
        } else {
            profileData.styles = { ...DEFAULT_STYLES, ...importedData.styles };
            importedData.styles = profileData.styles;
        }

        if (importedData.friends) {
          importedData.friends.forEach(friend => {
            if (friend.badge && !friend.verified) {
              friend.verified = true;
            }
            delete friend.badge;
          });
        }

        if (importedData.characters) {
          importedData.characters.forEach(char => {
            if (char.badge && !char.verified) {
              char.verified = true;
            }
          });
        }

        if (importedData.posts) {
            importedData.posts.forEach(post => {
                if (!post.reactionEmojis) post.reactionEmojis = 'üëçüíñüòÜ';
                if (post.commentsData) {
                    processCommentsForCompatibility(post.commentsData);
                }
            });
        }
        
        profileData = {
          name: importedData.name || "",
          profilePic: importedData.profilePic || "",
          cover: importedData.cover || "",
          badge: importedData.badge || "",
          followers: importedData.followers || "",
          info: importedData.info || "",
          infoDetails: importedData.infoDetails || "",
          photos: importedData.photos || [],
          friends: importedData.friends || [],
          posts: importedData.posts || [],
          characters: importedData.characters || [],
          styles: importedData.styles
        };

        saveProfile();
        applyStylesToCSS();
        renderAll();
        alert("Perfil importado correctamente");
      } catch (error) {
        alert("Error al importar el archivo: " + error.message);
      }
    };
    reader.readAsText(file);
  }
</script>
</body>
</html>
